services:
  opencode:
    image: pandeiro/openmoco:latest
    container_name: openmoco
    ports:
      - "127.0.0.1:7777:8080"  # Only expose on localhost for security
    labels:
      - "logging=enabled"
    volumes:
      # Workspace directory (where repos live)
      - ./workspace:/workspace:rw
      
      # OpenCode data persistence (sessions, SQLite DB)
      - opencode_data:/root/.local/share/opencode:rw

      # Persistent toolchain (mise installed languages/tools)
      - mise_data:/root/.local/share/mise:rw

      # OpenCode state persistence
      - opencode_state:/root/.local/state/opencode:rw

      # OpenCode config (generated by container)
      - opencode_config:/root/.config/opencode:rw
      
      # SSH keys for git authentication (read-only for security)
      - ./ssh:/root/.ssh:ro
      
      # Config directory for repos.txt
      - ./config:/config:ro
      
      # Optional: Git config (if you want to pre-configure)
      # - ./gitconfig:/root/.gitconfig:ro
    
    environment:
      # Git configuration
      - GIT_USER_NAME=${GIT_USER_NAME}
      - GIT_USER_EMAIL=${GIT_USER_EMAIL}
      
      # OpenCode password (REQUIRED)
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD}

      # Ollama API key (optional)
      - OLLAMA_API_KEY=${OLLAMA_API_KEY:-}

      # Google AI Studio API key (optional)
      - GOOGLE_AI_STUDIO_API_KEY=${GOOGLE_AI_STUDIO_API_KEY:-}

      # OpenCode configuration (adjust as needed)
      - NODE_ENV=production
    
    restart: unless-stopped
    
    # Uncomment if you need to access other services
    # networks:
    #   - app-network

# Uncomment if using custom networks
# networks:
#   app-network:
#     driver: bridge

volumes:
  opencode_data:
  opencode_state:
  opencode_config:
  mise_data:
